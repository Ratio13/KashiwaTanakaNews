<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>柏の葉＆柏たなか地域向け最新情報ページ</title>
  <meta name="description" content="柏市（柏の葉・柏たなか地区）の最新情報を年代別に提供する住民サポートサイトです。">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@400;500&family=Zen+Maru+Gothic:wght@400;700&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --primary-color: #f7b42c;
      --secondary-color: #f89b29;
      --bg-color: #fffaf5;
      --header-bg: #ffffff;
      --text-color: #4a4a4a;
      --table-bg: #ffffff;
      --border-radius: 12px;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      --student-color: #4facfe;
      --worker-color: #f093fb;
      --senior-color: #43e97b;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Zen Maru Gothic', sans-serif;
      line-height: 1.6;
      background-color: var(--bg-color);
      color: var(--text-color);
      font-size: 16px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    header {
      background-color: var(--header-bg);
      padding: 40px 0 30px;
      text-align: center;
      border-bottom: 2px solid #eee;
    }

    header h1 {
      font-family: 'Kiwi Maru', serif;
      font-size: 2rem;
      color: #d17b0f;
      margin-bottom: 10px;
    }

    .subtitle {
      font-size: 1rem;
      color: #666;
    }

    nav {
      background-color: white;
      padding: 15px 0;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .tabs {
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    .tab-btn {
      padding: 10px 20px;
      border: 1px solid #eee;
      background: #f8f8f8;
      border-radius: 50px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #888;
    }

    .tab-btn.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
      box-shadow: 0 4px 10px rgba(247, 180, 44, 0.3);
    }

    main {
      padding: 30px 0;
    }

    .table-container {
      background: var(--table-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      overflow-x: auto;
      border: 1px solid #eee;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }

    th {
      background: #fdfdfd;
      text-align: left;
      padding: 15px;
      font-weight: bold;
      color: #777;
      border-bottom: 2px solid #eee;
      white-space: nowrap;
    }

    td {
      padding: 15px;
      border-bottom: 1px solid #f5f5f5;
      vertical-align: top;
    }

    tr:hover td {
      background-color: #fffef9;
    }

    .col-date {
      width: 100px;
      color: #999;
      font-size: 0.9rem;
    }

    .col-sche {
      width: 120px;
      color: #d17b0f;
      font-weight: bold;
      font-size: 0.9rem;
    }

    .col-content {
      min-width: 300px;
    }

    .col-audience {
      width: 180px;
    }

    .news-title {
      display: block;
      font-weight: bold;
      color: #333;
      text-decoration: none;
      margin-bottom: 5px;
      font-size: 1.1rem;
    }

    .news-title:hover {
      color: var(--primary-color);
      text-decoration: underline;
    }

    .news-summary {
      font-size: 0.9rem;
      color: #666;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .tag {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: bold;
      margin: 2px;
      color: white;
    }

    .tag-student {
      background: var(--student-color);
    }

    .tag-worker {
      background: var(--worker-color);
    }

    .tag-senior {
      background: var(--senior-color);
    }

    .empty-msg {
      text-align: center;
      padding: 50px;
      color: #bbb;
    }

    footer {
      padding: 40px 0;
      text-align: center;
      color: #ccc;
      font-size: 0.8rem;
    }

    @media (max-width: 768px) {
      .col-summary {
        display: none;
      }
    }
  </style>
</head>

<body>

  <header>
    <div class="container">
      <h1>柏の葉＆柏たなか地域向け最新情報ページ</h1>
      <p class="subtitle">公式情報を分かりやすく、あなたの暮らしにあわせて。</p>
      <div id="last-fetched" style="font-size: 0.75rem; color: #ccc; margin-top: 10px;"></div>
    </div>
  </header>

  <nav>
    <div class="container">
      <div class="tabs">
        <button class="tab-btn active" data-tab="all">すべて</button>
        <button class="tab-btn" data-tab="student">学生向け</button>
        <button class="tab-btn" data-tab="worker">社会人向け</button>
        <button class="tab-btn" data-tab="senior">高齢者向け</button>
      </div>
    </div>
  </nav>

  <main class="container">
    <div class="table-container">
      <table id="news-table">
        <thead>
          <tr>
            <th class="col-date">発表日</th>
            <th class="col-sche">実施予定日</th>
            <th class="col-content">最新情報（見出し・要約）</th>
            <th class="col-audience">対象</th>
          </tr>
        </thead>
        <tbody id="news-body">
          <!-- JSで挿入 -->
        </tbody>
      </table>
    </div>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2026 柏市地域情報サポーター</p>
    </div>
  </footer>

  <script>
    const audienceLabels = {
      student: "学生向け",
      worker: "社会人向け",
      senior: "高齢者向け"
    };

    let allNews = [];

    async function loadNews() {
      const tbody = document.getElementById('news-body');
      try {
        const res = await fetch('data/news.json', { cache: 'no-store' });
        const data = await res.json();
        allNews = data.items;

        document.getElementById('last-fetched').textContent =
          `更新日時: ${new Date(data.fetchedAt).toLocaleString('ja-JP')}`;

        renderNews('all');
      } catch (e) {
        console.error(e);
        tbody.innerHTML = '<tr><td colspan="4" class="empty-msg">読み込みに失敗しました。</td></tr>';
      }
    }

    function parseScheduledDate(title, body) {
      // タイトルや本文から日付らしいものを抽出
      const dateRegex = /(\d+月\d+日)/;
      const match = title.match(dateRegex) || (body && body.match(dateRegex));
      return match ? match[1] : "-";
    }

    function getAudienceTags(audiences) {
      if (!audiences) return [];
      // 互換性維持: audiencesが単なる文字列配列の場合と、オブジェクト配列の場合を両方ハンドル
      if (Array.isArray(audiences)) {
        return audiences.map(a => {
          if (typeof a === 'string') return a;
          if (a.tags) return a.tags;
          return null;
        }).flat().filter(Boolean);
      }
      return [];
    }

    function renderNews(filterTab) {
      const tbody = document.getElementById('news-body');
      tbody.innerHTML = '';

      const filtered = filterTab === 'all'
        ? allNews
        : allNews.filter(item => {
          const tags = getAudienceTags(item.audiences);
          return tags.includes(filterTab);
        });

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty-msg">表示できる情報はありません。</td></tr>';
        return;
      }

      filtered.forEach(item => {
        const tags = [...new Set(getAudienceTags(item.audiences))];
        const scheduledDate = parseScheduledDate(item.title, item.body);

        const tr = document.createElement('tr');

        // 発表日
        const tdDate = document.createElement('td');
        tdDate.className = 'col-date';
        tdDate.textContent = item.updated || '-';
        tr.appendChild(tdDate);

        // 実施予定日
        const tdSche = document.createElement('td');
        tdSche.className = 'col-sche';
        tdSche.textContent = scheduledDate;
        tr.appendChild(tdSche);

        // 内容
        const tdContent = document.createElement('td');
        tdContent.className = 'col-content';
        tdContent.innerHTML = `
          <a href="${item.url}" class="news-title" target="_blank" rel="noopener">${item.title}</a>
          <div class="news-summary">${item.summary || item.body || ''}</div>
        `;
        tr.appendChild(tdContent);

        // 対象
        const tdAudience = document.createElement('td');
        tdAudience.className = 'col-audience';
        tags.forEach(tag => {
          if (audienceLabels[tag]) {
            const span = document.createElement('span');
            span.className = `tag tag-${tag}`;
            span.textContent = audienceLabels[tag];
            tdAudience.appendChild(span);
          }
        });
        tr.appendChild(tdAudience);

        tbody.appendChild(tr);
      });
    }

    // Tab Events
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderNews(btn.dataset.tab);
      });
    });

    loadNews();
  </script>

</body>

</html>